# DemandWeatherPrice
Project - Fundamentals of Data Science  
Alex Heilman  
Kushagra Agarwal  

### Investigation and Exploration 
This dataset is an hourly record of electric generation by each source, actual electric demand, the weather conditions in five Spanish cities, and the price of energy in Spain over four years. The dataset was obtained from [Kaggle](https://www.kaggle.com/nicholasjhana/energy-consumption-generation-prices-and-weather) . Data regarding energy generation was acquired from ENTSO-E, the European Network of Transmission System Operators for Electricity, and the rates were collected from the Spanish operator Red Electric España. Weather data was acquired from Open Weather API, an open source collection of publicly available weather station data. Weather data for the five largest Spanish cities were used – Madrid, Barcelona, Bilbao, Seville, and Valencia. Although the accuracy of these datasets cannot be determined, the sources appear to be reputable.  

In order to use these six different time-series datasets, meticulous wrangling and synchronization was performed. This combined dataset contains hourly generation by type, energy price, electric consumption, and weather readings for January 1, 2015 through December 31, 2018. Due to the nature of time-series data, random selection of training data would not be suitable for this application. The training set was selected sequentially using the first 80% of the data. The intention is to use earlier data to test on later data.  

Several instances of duplicated weather entries were deleted during this process. Within the electric data, N/A values were corrected with mean imputation of the training set only, as to not improperly bias the data. If these rows were to have been deleted, certain hours and days would be weighted unintentionally. These N/A values were examples of “missingness completely at random”, because there was no systematic explanation and their occurrence had nothing to do with the covariates. Multiple weather covariates were determined to be irrelevant for this analysis. Colinear temperature covariates were deleted from the dataset. The remaining temperature covariates for each city were transformed from units of Kelvin into units of Celsius for easier interpretation. Weather ID number, weather description, and weather icon were all deleted. Threehour rainfall and snowfall readings were deleted in favor of the more applicable one-hour readings.  

The original timestamp for the observations was of the form “2015-01-31 17:00:00+01:00”, giving little flexibility for analysis. This covariate was transformed into four separate covariates: the year ranging from 2015 to 2018, the month ranging from 1 to 12, the day ranging from 1 to 31, and the hour ranging from 1 to 24. This crucial transformation informed the 1  relevant patterns between demand, price, time of day, and month of the year. This supported the expectation that higher electric demand correlated with morning hours, after-work hours, hot summer months, and cold winter months.  

Ggpairs was used to identify correlations between different covariates and implement interaction terms in the regression model. Strong correlations were observed in the generation covariates (natural gas, coal, etc.) and interaction terms were added accordingly. Temperature and relative humidity were negatively correlated - a relationship established by physics. Both temperature and pressure were highly correlated amongst the five cities. Due to their close geographic proximity, this result was expected. A strong correlation was observed between electric demand and temperature for all five cities. This result was anticipated, as electric heating and air conditioning are strong drivers of residential electric demand. However, a surprising result was Madrid and Barcelona temperatures correlating the least with electric demand. Given that these are the two largest cities in Spain by population, it was assumed they would demonstrate the strongest correlation. Perhaps the most spurious correlation observed was between the barometric pressure of Bilbao and price of energy.  

A strong positive correlation between price and demand was observed, although not immediately obvious. The coefficient for demand in kilowatts was positive, indicating the relationship we assumed, but of surprisingly low magnitude. The low magnitude was a result of the relative scaling and the strong correlation was evident after standardization. This result is slightly counterintuitive but reflects a common pricing structure designed to disincentivize high demand during peak hours. Figure 1, a scatterplot illustrating this relationship, is included below.  
| Figure 1 <br/> *Electric Demand vs. Price of Energy* |
| --- |
| <img align="center" width="450" height="450" src="/Figures/Figure_1.png"> |

The chosen continuous response variable is the energy price for small consumers (less than ten kilowatts) in euros per megawatt hour. The prediction of this outcome is valuable to the energy futures market, where day-ahead purchases are made in the day-ahead market. The binary response variable is an indicator of the demand at a given hour and takes a value of 1 only if the demand for that hour is expected to be greater than the previous hour - otherwise its value is 0.  

Prediction of energy price and electric demand are immensely valuable to industry experts. This information is used for power generation planning and to execute electric power futures in the wholesale energy market. Bulk energy storage is scarcely implemented, meaning electric generation and demand must always balance. Due to poor generation planning and demand prediction, arbitrage opportunities occasionally emerge in the market. These opportunities can be capitalized on if generation assets in the power pool respond quickly. As utilities perform integrated resource planning, future system demand predictions provide key insights and identify necessary infrastructure upgrades. A robust prediction model for both energy price and electric demand answers critical questions for several applications. 

### Predictive Regression 
To ensure accurate predictions of energy price given the covariates of generation and weather at a specific hour, the objective of the predictive regression model was to minimize prediction error. Because OLS often results in a low prediction error for linear population models, the prediction error for a model with all single-ordered covariates was used as the baseline for comparison against other models. The estimate of the prediction error, however, could not be carried out by general cross-validation due to the time-series data. Prediction involving time-series data usually requires prediction for future observations based on past events. As cross validation does not maintain such sequentiality, the measured error would be invalid. Instead, a simple trainvalidate approach was employed after splitting the training dataset further into separate training and validation sets with an 80/20 ratio. After training a model with the new training dataset, the root-mean-squared error (RMSE) was calculated between actual price in the validation set and the predicted price generated by the model.  

Given that many covariates demonstrated high correlation with each other, it was expected that the inclusion of interaction terms in the regression model would decrease the prediction error. However, given the presence of 55 covariates in the dataset and 1485 corresponding pairs, identifying the relevant interaction terms was time-consuming and difficult. After the addition of interaction terms for all covariate pairs with high correlation as observed using ggpairs, rigorous optimization of the model was carried out by checking the new RMSE resulting from the exclusion of each interaction term. The same process was also applied to check for beneficial logarithmic transformations of the covariates. The model with the least validation error, labelled LM1 in the Appendix, contains mostly interaction terms and a single log transform, in addition to the other single-ordered covariates. The RMSE of LM1 was 7.99 while the baseline was 9.27. This model was chosen as the “best” regression model and is likely to provide an approximate test error higher than 7.99, since train-test generally underestimates the true prediction error and the number of observations in the validation set was low.  

This RMSE optimization provides an overly optimistic estimate of test error. To ensure that the reduction in RMSE was indeed justified and not simply due to the validation set being highly favorable to the model, bias-variance decomposition analysis was carried out. The density plots of the RMSE for LM1 and the baseline model (Figure 2 below) clearly indicate that LM1 has a lower bias than the baseline model, although LM1 appears to have higher variance. It is also inferred from the high bias in both models that key population covariates are missing from the dataset. Apart from OLS, k-nearest neighbors(k-NN) and ridge regression were also pursued. Since the linearity of the population model was uncertain, k-NN was implemented to circumvent assumptions about the population model. However, k-NN was not only slow but also seemed to saturate around an RMSE of 10, illustrated by Figure 3 below. Similarly, Ridge regression was unsuccessful in reducing the validation RMSE further than LM1.  
| Figure 2 <br/> *Density Plot of RMSE for Improved Model and Baseline* |
| --- |
| <img align="center" width="450" height="450" src="/Figures/Figure_2.png"> |  

| Figure 3 <br/> *RMSE vs. K for k-NN* |
| --- |
| <img align="center" width="450" height="450" src="/Figures/Figure_3.png"> |



### Predictive Classification 
The classifier was designed to predict if the demand for electricity at a given hour is greater than it was during the hour immediately preceding it. Such a classifier could be valuable for a utility to quickly anticipate a rise in demand, based on the amount of energy generated by different sources and the weather conditions at a certain time. While both false positives and negatives are undesirable, closer analysis reveals that false negatives would be much more consequential to the utility than false positives. If a rise in demand is missed, additional energy would have to be purchased from elsewhere at higher market prices, whereas surplus energy generation could either be stored or sold at market value. Therefore, instead of minimizing the average 0-1 loss, the objective of the classifier was to maximize the true positive rate (TPR) while keeping the false positive rate (FPR) below manageable limits.  

A new covariate was created in both the training and validation sets, with a value of 1 if the demand for the ith observation was greater than the demand in the (i-1)th observation, and value 0 otherwise. The missing element in the first observation of the training set was replaced by the majority between 0’s and 1’s in the covariate column. A logistic regression model containing all covariates was then trained on the training set, the corresponding log odds ratios were collected for the validation set, and the TPR and FPR were calculated for a threshold 0 ≤ t ≤ 1. The ROC curve, shown in Figure 4 below, was obtained by plotting the TPR vs FPR values generated while sweeping through t. The ROC curve indicates that, starting from the top-right corner of the plot, around t=0.25, while the TPR reduces by 1 unit, the FPR reduces by three units. The TPR and FPR values at t=0.25 were 0.86 and 0.64 respectively and were set as the baseline.  
| Figure 4 <br/> *ROC Curves for Base Model* |
| --- |
| <img align="center" width="450" height="450" src="/Figures/Figure_4.png"> |

It was expected that a logistic regression model containing the same terms as the formula of LM1 would have an improved classification. This expected result was not observed. Despite the optimization of the formula, 0.87 and 0.65 were the best values of TPR and FPR that could be achieved. Figure 5 in the Appendix contains the ROC curves for the baseline model and the optimized logistic regression model plotted together.  
| Figure 5 <br/> *ROC Curves for Base Model and Improved Logistic Regression Model* |
| --- |
| <img align="center" width="450" height="450" src="/Figures/Figure_5.png"> |

Finally, the k-NN algorithm was applied as a classifier. By cycling through different values of k and L, it was found that k=25, L=25 resulted in TPR=1, and FPR=0. Hence this model, named ‘k-NN’ in the Appendix, classifies the validation set perfectly. Although this result is not indicative of a model generalizing perfectly for all test cases, it is certainly an indication of good performance. It should also be noted that the number of observations in the validation set was small. The TPR and FPR are expected to decrease and increase respectively during testing, but the classifier performs commendably, nevertheless.  

The OLS regression model with interaction terms and the k-NN binary classifier model both performed well in the validation stage of model testing. Due to validation bias, it is expected that these models will likely perform with higher test RMSE than observed by the validation RMSE. Even with this likely outcome, both models are performing well for this stage. 
